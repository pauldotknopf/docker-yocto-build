#!/bin/bash

set -e

DIRNAME="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd $DIRNAME

GIT_VERSION_JSON=`./gitversion`
GIT_SEMVAR_VERSION=`echo $GIT_VERSION_JSON | jq '.SemVer' --raw-output`
GIT_VERSION_PRERELEASE_LABEL=`echo $GIT_VERSION_JSON | jq '.PreReleaseLabel' --raw-output`

if [ -z "$GIT_VERSION_PRERELEASE_LABEL" ]; then
  docker tag docker-yocto-build:trusty pauldotknopf/docker-yocto-build:trusty
  docker tag docker-yocto-build:xenial pauldotknopf/docker-yocto-build:xenial
fi
docker tag docker-yocto-build:trusty pauldotknopf/docker-yocto-build:trusty-v$GIT_SEMVAR_VERSION
docker tag docker-yocto-build:xenial pauldotknopf/docker-yocto-build:xenial-v$GIT_SEMVAR_VERSION

if [ -z "$GIT_VERSION_PRERELEASE_LABEL" ]; then
  docker push pauldotknopf/docker-yocto-build:trusty
  docker push pauldotknopf/docker-yocto-build:xenial
fi
docker push pauldotknopf/docker-yocto-build:trusty-v$GIT_SEMVAR_VERSION
docker push pauldotknopf/docker-yocto-build:xenial-v$GIT_SEMVAR_VERSION